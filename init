#!/usr/bin/env bash

set -o functrace

[[ -n $DEBUG ]] && TIMEFORMAT=' > %R seconds.' || TIMEFORMAT=''
[[ -n $DEBUG ]] && time=command time || time=

# load misc
INIT_HOME=$HOME/dotfiles
pushd $INIT_HOME >&1 >/dev/null
source misc
source bash_prompt

export BASH_COMPLETION_USER_DIR="$HOME/.local/share/bash-completion"
mkdir -p $BASH_COMPLETION_USER_DIR/completions

# Source completions
time {
if [[ ! -f $BASH_COMPLETION_USER_DIR/completions/kubectl ]] && is_app_installed kubectl; then
  kubectl completion bash > $BASH_COMPLETION_USER_DIR/completions/kubectl
fi
if [[ ! -f $BASH_COMPLETION_USER_DIR/completions/k3d ]] && is_app_installed k3d; then
  k3d completion bash > $BASH_COMPLETION_USER_DIR/completions/k3d
fi
if [[ ! -f $BASH_COMPLETION_USER_DIR/completions/helm ]] && is_app_installed helm; then
  helm completion bash > $BASH_COMPLETION_USER_DIR/completions/helm
fi
}

# install fzf
if [ ! -d "$WORKDIR/.fzf" ]; then
  if is_app_installed git; then
    git clone --quiet --depth 1 https://github.com/junegunn/fzf.git $WORKDIR/.fzf
    $WORKDIR/.fzf/install --completion --key-bindings --no-update-rc
  fi
fi
[ -f ~/.fzf.bash ] && source ~/.fzf.bash

time {
scripts=(`find . -mindepth 2 -maxdepth 2 -not -path "./.git/*" -perm /u+x -type f`)
[[ -n $DEBUG ]] && debug "scripts: ${scripts[@]}"
}

for script in "${scripts[@]}"; do
  if [[ "$script" =~ ^.*/init$ ]]; then
    [[ -n $DEBUG ]] && debug "loading ${script}"
    time {
      source ${script}
    }
    continue
  fi
  path=$(dirname $(realpath "${script}"))
  if [[ "$PATH" != *${path}* ]]; then
    PATH=${PATH}:${path}
    [[ -n $DEBUG ]] && debug "\$PATH:${path}"
  fi
done
pushd -0 >&1 >/dev/null
dirs -c

unset TIMEFORMAT
unset scripts
